<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>AGENDAMENTO - MÓVEIS SIMONETTI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Bibliotecas -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/scroller/2.2.5/js/dataTables.scroller.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- CSS DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.2.5/css/scroller.dataTables.min.css"/>

<style>
:root {
  --cor-fundo-dashboard: #fafafa;
  --cor-cabecalho: linear-gradient(90deg, #ff6666, #cc0000);
  --cor-texto-cabecalho: #ffffff;
  --cor-linha-par: #ffe5e5;
  --cor-linha-impar: #fff5f5;
  --cor-filtro: linear-gradient(90deg, #fff5f5, #ffe5e5);
}
body { font-family: 'Segoe UI', sans-serif; background-color: var(--cor-fundo-dashboard); color: #333; padding: 10px; margin: 0; }
header { text-align: center; margin-bottom: 20px; }
h1 { color: #cc0000; font-size: 6vw; margin: 10px 0 20px 0; font-weight: bold; }
@media (min-width: 768px) { h1 { font-size: 28px; } }
.table-container { overflow-x: auto; border: 1px solid #ff9999; border-radius: 6px; margin-top: 10px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
table { border-collapse: collapse; font-size: 13px; width: 100%; min-width: 900px; table-layout: fixed; }
thead tr th { background: var(--cor-cabecalho); color: var(--cor-texto-cabecalho); padding: 6px 4px; text-align: center; font-weight: bold; white-space: nowrap; vertical-align: top; }
tbody tr:nth-child(even) { background-color: var(--cor-linha-par); }
tbody tr:nth-child(odd) { background-color: var(--cor-linha-impar); }
td, th { border: 1px solid #ddd; box-shadow: inset 0 0 2px rgba(0,0,0,0.05); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
td { padding: 8px 12px; border-bottom: 1px solid #eee; cursor: default; }

/* Cabeçalho com filtro */
.header-filter {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 6px;
  width: 100%;
  height: 100%;
  box-sizing: border-box;
}
.header-filter span {
  font-size: 12px;
  font-weight: bold;
  color: #fff;
  text-align: center;
  line-height: 1.2;
  white-space: nowrap;
}
.header-filter select {
  width: 100%;
  min-width: 120px;
  padding: 6px 10px;
  font-size: 13px;
  border-radius: 6px;
  border: 1px solid #cc0000;
  background: var(--cor-filtro);
  color: #333;
  text-align: center;
  box-sizing: border-box;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
.header-filter select:hover {
  border-color: #a30000;
  background: #ffe5e5;
}

/* Apenas SENHA DE AGENDAMENTO com quebra de linha */
thead th.senha-agendamento .header-filter span {
  white-space: normal;
  word-wrap: break-word;
}

/* Aumenta largura da coluna TIPO DE PRODUTO */
thead th.tipo-produto { min-width: 200px !important; }

/* Menu compartilhar */
.menu { position: relative; display: inline-block; margin-bottom: 10px; }
.menu button { background: #cc0000; color: #fff; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background 0.3s; }
.menu button:hover { background: #a30000; }
.menu-content { display: none; position: absolute; background: #fff; color: #333; box-shadow: 0px 4px 8px rgba(0,0,0,0.1); z-index: 1; min-width: 150px; border-radius: 4px; }
.menu-content a { display: block; padding: 10px; text-decoration: none; color: #333; font-size: 14px; }
.menu-content a:hover { background: #fbeaea; }
.menu:hover .menu-content { display: block; }

/* Modal popup */
#modalCarga {
  display:none;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
  justify-content:center;
  align-items:center;
}
#modalCarga .modal-content {
  background:#fff;
  padding:20px;
  border-radius:8px;
  max-width:400px;
  width:90%;
  text-align:center;
  position:relative;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
#modalCarga .modal-content h2 { color:#cc0000; margin-bottom:10px; }
#modalCarga .modal-content p { font-size:14px; word-break:break-word; }
.close-modal {
  position:absolute;
  top:10px;
  right:15px;
  cursor:pointer;
  font-weight:bold;
  font-size:18px;
}

/* Responsivo melhorado para botões e selects */
@media (max-width: 768px) {
  .menu button { padding: 6px 10px; font-size: 13px; }
  .header-filter select { padding: 6px; font-size: 13px; min-width: 100px; }
  h1 { font-size: 22px; }
}
</style>
</head>
<body>

<script>
if (localStorage.getItem("isLoggedIn") !== "true") { window.location.href = "login.html"; }
</script>

<div id="userBar" style="background:#E6E6E6; padding:10px; display:flex; justify-content:space-between; align-items:center; border-radius:6px; margin-bottom:12px;">
  <span id="welcomeUser" style="font-weight:bold; color:#333;"></span>
  <button onclick="logout()" style="background:#CC0000; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">Sair</button>
</div>
<script>
const username = localStorage.getItem("username") || "Usuário";
document.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("welcomeUser").textContent = "Bem-vindo, " + username;
});
function logout(){
  localStorage.removeItem("isLoggedIn");
  localStorage.removeItem("username");
  window.location.href = "login.html";
}
</script>

<header>
  <h1>AGENDAMENTO - MÓVEIS SIMONETTI</h1>
</header>

<div class="menu">
  <button>📤 Compartilhar</button>
  <div class="menu-content">
    <a href="#" onclick="exportarPDF()">Exportar PDF</a>
    <a href="#" onclick="exportarExcel()">Exportar Excel</a>
  </div>
</div>

<div class="table-container">
  <table id="planilha" class="display nowrap">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal popup -->
<div id="modalCarga">
  <div class="modal-content">
    <span class="close-modal">×</span>
    <h2>Detalhes</h2>
    <p id="conteudoCarga"></p>
  </div>
</div>

<script>
const sheetID = "1Ore02M4GARvE6hldNDZmiVNDrABb4dgaZO7wlMY-fjs";
const gidPinheiros = "0";
const gidSerra = "353068485";
const urls = [
  `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gidPinheiros}`,
  `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gidSerra}`
];
let allData = [];
let colunas = ["SENHA DE AGENDAMENTO", "DATA", "CENTRAL", "CARGAS", "FORNECEDOR", "TIPO DE PRODUTO", "PRODUTO"];

function carregarDados(url, callback) {
  Papa.parse(url, { download:true, header:true, complete:function(results){
      const dadosFiltrados = results.data.filter(row => colunas.some(c => row[c] && row[c].trim() !== ""));
      allData = allData.concat(dadosFiltrados);
      callback();
  }});
}

function inicializarTabela() {
  if(allData.length===0) return;
  const tabela = $("#planilha").DataTable({
    data: allData,
    columns: colunas.map(c => ({
      data: c,
      render: function(data, type, row, meta){
        if(c === "CARGAS" || c === "SENHA DE AGENDAMENTO"){
          return `<span class="popup-cell" data-col="${c}" style="color:#000;cursor:pointer;" title="Clique para detalhes">${data}</span>`;
        }
        return data;
      }
    })),
    deferRender: true,
    scrollX: true,
    scroller: true,
    paging: true,
    pageLength: 50,
    lengthMenu: [25,50,100,200],
    searching: true,
    autoWidth: false,
    columnDefs: [
      { targets: 0, width: "350px", className: "senha-agendamento" },
      { targets: 1, width: "100px" },
      { targets: 2, width: "120px" },
      { targets: 3, width: "150px" },
      { targets: 4, width: "150px" },
      { targets: 5, width: "220px", className: "tipo-produto" },
      { targets: 6, width: "180px" }
    ],
    language: { 
      decimal: ",",
      thousands: ".",
      search: "🔍 Buscar:",
      zeroRecords: "Nenhum registro encontrado",
      info: "Mostrando de _START_ até _END_ de _TOTAL_ registros",
      infoEmpty: "Mostrando 0 até 0 de 0 registros",
      infoFiltered: "(filtrado de _MAX_ registros no total)",
      lengthMenu: "Mostrar _MENU_ registros por página",
      loadingRecords: "Carregando...",
      processing: "Processando...",
      paginate: { first: "Primeiro", previous: "Anterior", next: "Próximo", last: "Último" }
    },
    initComplete: function(){
      const api = this.api();
      colunas.forEach((colName, i) => {
        const column = api.column(i);
        const $header = $(column.header()).empty();
        $header.addClass(colName === "SENHA DE AGENDAMENTO" ? "senha-agendamento" : "");
        $header.addClass(colName === "TIPO DE PRODUTO" ? "tipo-produto" : "");
        $header.append(`
          <div class="header-filter">
            <span>${colName}</span>
            <select class="filter-select"><option value="">Filtrar / Limpar</option></select>
          </div>
        `);
      });
      function atualizarFiltros() {
        const dadosFiltrados = api.rows({ search: 'applied' }).data().toArray();
        colunas.forEach((colName, i) => {
          const select = $(api.column(i).header()).find('select');
          const valAtual = select.val();
          select.empty().append(`<option value="">Filtrar / Limpar</option>`);
          let uniqueVals = [...new Set(dadosFiltrados.map(r => r[colName]).filter(Boolean))];
          if(colName === "DATA"){
            uniqueVals.sort((a,b)=>{ const toTime=v=>{ const [d,m,y]=v.split("/").map(Number); return new Date(y,m-1,d).getTime(); }; return toTime(a)-toTime(b); });
          } else { uniqueVals.sort(); }
          uniqueVals.forEach(d=>select.append(`<option value="${d}">${d}</option>`));
          if(uniqueVals.includes(valAtual)) select.val(valAtual);
        });
      }
      atualizarFiltros();
      api.columns().every(function(i){
        $(this.header()).find('select').on('change', function(){
          const val = $(this).val();
          api.column(i).search(val ? '^'+$.fn.dataTable.util.escapeRegex(val)+'$' : '', true, false).draw();
        });
      });
      api.on('draw', atualizarFiltros);

      // Popup CARGAS e SENHA DE AGENDAMENTO
      $('#planilha tbody').on('click', '.popup-cell', function(){
        const conteudo = $(this).text();
        const coluna = $(this).data('col');
        const titulo = coluna === "CARGAS" ? "Detalhes da Carga" : "Senha de Agendamento";
        $('#modalCarga h2').text(titulo);
        $('#conteudoCarga').text(conteudo);
        $('#modalCarga').css('display','flex');
      });
      $('.close-modal').on('click', function(){ $('#modalCarga').hide(); });
      $('#modalCarga').on('click', function(e){ if(e.target.id === 'modalCarga') $(this).hide(); });
    }
  });
}

carregarDados(urls[0], function(){ carregarDados(urls[1], inicializarTabela); });

function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape');
  const tabela = $("#planilha").DataTable();
  const dadosVisiveis = tabela.rows({ search: 'applied' }).data().toArray();
  const headers = colunas;
  const rows = dadosVisiveis.map(r => colunas.map(c => r[c] || ""));
  doc.autoTable({ head: [headers], body: rows, startY: 20, styles: { fontSize: 9, cellPadding: 3, halign: 'center', valign: 'middle', overflow: 'linebreak' }});
  const dataHoje = new Date().toLocaleDateString('pt-BR');
  doc.save(`agendamento_${dataHoje}.pdf`);
}

function exportarExcel(){
  const tabela = $("#planilha").DataTable();
  const dadosVisiveis = tabela.rows({ search: 'applied' }).data().toArray();
  const headers = colunas;
  const rows = dadosVisiveis.map(r => colunas.map(c => r[c] || ""));
  const ws_data = [headers, ...rows];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  ws['!cols'] = headers.map(() => ({ wch: 20 }));
  XLSX.utils.book_append_sheet(wb, ws, "Agendamento");
  const dataHoje = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  XLSX.writeFile(wb, `agendamento_${dataHoje}.xlsx`);
}
</script>

</body>
</html>
