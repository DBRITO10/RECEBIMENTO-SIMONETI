<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>AGENDAMENTO - MÃ“VEIS SIMONETTI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bibliotecas -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <!-- CSS DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

  <style>
    :root {
      --cor-fundo-dashboard: #fafafa;
      --cor-cabecalho: linear-gradient(90deg, #ff6666, #cc0000);
      --cor-texto-cabecalho: #ffffff;
      --cor-linha-par: #ffe5e5;
      --cor-linha-impar: #fff5f5;
      --cor-filtro: #ffcccc;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--cor-fundo-dashboard);
      color: #333;
      padding: 10px;
      margin: 0;
    }

    header { text-align: center; margin-bottom: 20px; }

    h1 {
      color: #cc0000;
      font-size: 6vw;
      margin: 10px 0 20px 0;
      font-weight: bold;
    }

    @media (min-width: 768px) {
      h1 { font-size: 28px; }
    }

    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid #ff9999;
      border-radius: 6px;
      margin-top: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    table {
      border-collapse: collapse;
      font-size: 13px;
      width: 100%;
      min-width: 800px;
    }

    thead tr th {
      background: var(--cor-cabecalho);
      color: var(--cor-texto-cabecalho);
      padding: 8px 12px;
      text-align: center;
      font-weight: bold;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) { background-color: var(--cor-linha-par); }
    tbody tr:nth-child(odd) { background-color: var(--cor-linha-impar); }

    td, th {
      border: 1px solid #ddd;
      box-shadow: inset 0 0 2px rgba(0,0,0,0.05);
    }

    td {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      text-align: center;
    }

    .filter-select {
      width: 100%;
      min-width: 70px;
      padding: 6px 8px;
      font-size: 13px;
      background: var(--cor-filtro);
      border: none;
      border-radius: 4px;
      color: #333;
      text-align: center;
      box-sizing: border-box;
    }

    .menu {
      position: relative;
      display: inline-block;
      margin-bottom: 10px;
    }

    .menu button {
      background: #cc0000;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .menu button:hover {
      background: #a30000;
    }

    .menu-content {
      display: none;
      position: absolute;
      background: #fff;
      color: #333;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
      z-index: 1;
      min-width: 150px;
      border-radius: 4px;
    }

    .menu-content a {
      display: block;
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-size: 14px;
    }

    .menu-content a:hover {
      background: #fbeaea;
    }

    .menu:hover .menu-content { display: block; }
  </style>
</head>
<body>

<header>
  <h1>AGENDAMENTO - MÃ“VEIS SIMONETTI</h1>
</header>

<!-- BotÃ£o Compartilhar -->
<div class="menu">
  <button>ðŸ“¤ Compartilhar</button>
  <div class="menu-content">
    <a href="#" onclick="exportarPDF()">Exportar PDF</a>
    <a href="#" onclick="exportarExcel()">Exportar Excel</a>
  </div>
</div>

<div class="table-container">
  <table id="planilha" class="display nowrap">
    <thead>
      <tr class="headers"></tr>
      <tr class="filters"></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const sheetID = "1Ore02M4GARvE6hldNDZmiVNDrABb4dgaZO7wlMY-fjs";
const gidPinheiros = "0";
const gidSerra = "353068485";

const urls = [
  `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gidPinheiros}`,
  `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gidSerra}`
];

let allData = [];
// colunas fixas solicitadas
let colunas = ["DATA", "CENTRAL", "CARGA/TRANSPORTE", "FORNECEDOR", "TIPO DE PRODUTO"];

function carregarDados(url, callback) {
  Papa.parse(url, { 
    download:true, 
    header:true, 
    complete:function(results){
      allData = allData.concat(results.data);
      callback();
    }
  });
}

function inicializarTabela() {
  if(allData.length===0) return;

  const headerRow = document.querySelector("#planilha thead tr.headers");
  const filterRow = document.querySelector("#planilha thead tr.filters");
  const tableBody = document.querySelector("#planilha tbody");

  // monta cabeÃ§alho e filtros fixos
  colunas.forEach(col=>{
    headerRow.innerHTML += `<th>${col}</th>`;
    filterRow.innerHTML += `<th><select class="filter-select"><option value="">Filtrar</option></select></th>`;
  });

  // monta corpo da tabela apenas com as colunas desejadas
  allData.forEach(row=>{
    let rowHtml = "<tr>";
    colunas.forEach(col=>{
      rowHtml += `<td>${row[col] || ""}</td>`;
    });
    rowHtml += "</tr>";
    tableBody.innerHTML += rowHtml;
  });

  // ativa DataTable
  const table = $("#planilha").DataTable({
    paging: true,
    pageLength: 50,
    lengthMenu: [25, 50, 100, 200],
    searching: true,
    info: true,
    scrollX: true,
    autoWidth: false,
    language: { 
      search:"Buscar:", 
      zeroRecords:"Nenhum registro encontrado", 
      info:"Mostrando _START_ atÃ© _END_ de _TOTAL_ registros", 
      infoEmpty:"Nenhum dado disponÃ­vel", 
      lengthMenu: "Mostrar _MENU_ registros por pÃ¡gina"
    }
  });

  // filtros dinÃ¢micos
  table.columns().every(function(i){
    const column = this;
    const select = $(filterRow).find("select").eq(i);

    column.data().unique().sort().each(d=>{ if(d) select.append(`<option value="${d}">${d}</option>`); });

    const savedVal = localStorage.getItem('filtroColuna'+i);
    if(savedVal){
      select.val(savedVal);
      const valRegex = $.fn.dataTable.util.escapeRegex(savedVal);
      column.search(valRegex ? '^'+valRegex+'$' : '', true, false).draw();
    }

    select.on("change", function(){
      const val = $(this).val();
      localStorage.setItem('filtroColuna'+i, val);
      const valRegex = $.fn.dataTable.util.escapeRegex(val);
      column.search(valRegex ? '^'+valRegex+'$' : '', true, false).draw();
    });
  });
}

// carrega as abas PINHEIROS e SERRA
carregarDados(urls[0], function(){ carregarDados(urls[1], inicializarTabela); });

// exportaÃ§Ã£o PDF
function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape');
  const headers = [];
  document.querySelectorAll("#planilha thead tr.headers th").forEach(th=>headers.push(th.innerText));
  const rows = [];
  document.querySelectorAll("#planilha tbody tr").forEach(tr=>{
    const row = [];
    tr.querySelectorAll("td").forEach(td=>row.push(td.innerText));
    rows.push(row);
  });
  doc.autoTable({ head:[headers], body:rows, startY:20, styles:{fontSize:9, cellPadding:3, halign:'center', valign:'middle'} });
  const dataHoje = new Date().toLocaleDateString('pt-BR');
  doc.save(`agendamento_${dataHoje}.pdf`);
}

// exportaÃ§Ã£o Excel
function exportarExcel(){
  const headers = [];
  document.querySelectorAll("#planilha thead tr.headers th").forEach(th=>headers.push(th.innerText));
  const rows = [];
  document.querySelectorAll("#planilha tbody tr").forEach(tr=>{
    const row = [];
    tr.querySelectorAll("td").forEach(td=>row.push(td.innerText));
    rows.push(row);
  });
  const ws_data = [headers, ...rows];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws,"Agendamento");
  const dataHoje = new Date().toLocaleDateString('pt-BR').replace(/\//g,'-');
  XLSX.writeFile(wb, `agendamento_${dataHoje}.xlsx`);
}
</script>
</body>
</html>
