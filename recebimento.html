<script>
const sheetID = "1LaYf3GKID_HdueUpZax7J_aco2-a1UVFBz1pZ4CkUGk";
const gid = "0";
const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gid}`;
const colunasDesejadas = ["SENHA","DATA","CENTRAL","CARGA/TRANSPORTE","NOTAS","STATUS DA CARGA","FORNECEDOR","TIPO DE PRODUTO"];

Papa.parse(csvUrl, {
  download: true, header: true,
  complete: function (results) {
    const data = results.data;
    if (!data.length || Object.keys(data[0]).length === 0) { alert("Falha ao carregar dados."); return; }
    results.meta.fields = results.meta.fields.map(f => f.trim());
    data.forEach(row => { Object.keys(row).forEach(k => { if (k !== k.trim()) { row[k.trim()] = row[k]; delete row[k]; } }); });
    data.forEach(row => { colunasDesejadas.forEach(col => { if (row[col]) row[col] = row[col].trim(); }); });

    const headerRow = document.querySelector("#planilha thead tr.headers");
    const filterRow = document.querySelector("#planilha thead tr.filters");
    const tableBody = document.querySelector("#planilha tbody");

    colunasDesejadas.forEach(col => { 
      headerRow.innerHTML += `<th>${col}</th>`; 
      filterRow.innerHTML += `<th><select class="filter-select"><option value="">Filtrar</option></select></th>`; 
    });

    data.forEach(row => {
      let rowHtml = "<tr>";
      colunasDesejadas.forEach(col => {
        let valor = row[col] || "";
        if (col === "NOTAS" && valor === "") valor = "Sem nota";
        if (col === "NOTAS") { rowHtml += `<td class="nota-cell" data-nota="${valor}">${valor}</td>`; }
        else { rowHtml += `<td>${valor}</td>`; }
      });
      rowHtml += "</tr>"; tableBody.innerHTML += rowHtml;
    });

    // Inicializa DataTable com stateSave para manter filtros e busca
    const table = $("#planilha").DataTable({
      paging: false, searching: true, info: false, scrollX: true, autoWidth: false,
      fixedHeader: { header: true, headerOffset: 0 },
      stateSave: true,
      language: { search: "Buscar:", zeroRecords: "Nenhum registro encontrado", infoEmpty: "Nenhum dado disponÃ­vel" }
    });

    // Popular filtros e manter seleÃ§Ã£o ao recarregar
    table.columns().every(function () {
      const column = this;
      const select = $(".filters th").eq(column.index()).find("select");
      column.data().unique().sort().each(function (d) { if (d) select.append('<option value="'+d+'">'+d+'</option>'); });

      // Aplica valor salvo no stateSave
      const state = table.state.loaded();
      if (state) {
        const val = state.columns[column.index()].search.search;
        if (val) select.val(val.replace(/[\^$]/g,'')).trigger('change');
      }

      select.on("change", function () {
        const val = $.fn.dataTable.util.escapeRegex($(this).val());
        column.search(val ? '^'+val+'$' : '', true, false).draw();
      });
    });

    $(".dataTables_wrapper").css("position","relative");

    // BotÃ£o de compartilhamento
    $("#planilha_filter").append('<button id="btnShare">ðŸ“¤ Compartilhar</button><div id="shareMenu"><div class="share-option" data-type="pdf">ðŸ“„ Exportar PDF</div><div class="share-option" data-type="excel">ðŸ“Š Exportar Excel</div></div>');
    const shareBtn = document.getElementById("btnShare"); 
    const shareMenu = document.getElementById("shareMenu");
    shareBtn.addEventListener("click", () => {
      shareMenu.style.left = (shareBtn.offsetLeft)+"px";
      shareMenu.style.top = (shareBtn.offsetTop + shareBtn.offsetHeight + 5)+"px";
      shareMenu.style.display = "block";
    });
    document.addEventListener("click", (e) => { if (!shareBtn.contains(e.target) && !shareMenu.contains(e.target)) { shareMenu.style.display = "none"; } });
    $(document).on("click", ".share-option", function() { 
      const type = $(this).data("type"); 
      if (type === "pdf") exportPDF(table); 
      if (type === "excel") exportExcel(table); 
      shareMenu.style.display = "none"; 
    });

  }
});

// Pop-up nota
$(document).on("click", ".nota-cell", function() { 
  const nota = $(this).data("nota"); 
  $("#notaConteudo").text(nota); 
  $("#notaOverlay, #notaPopup").fadeIn(200); 
});
$("#fecharPopup, #notaOverlay").on("click", function() { 
  $("#notaOverlay, #notaPopup").fadeOut(200); 
});

// Export PDF/Excel
function exportPDF(table) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "landscape" });
  const headers = colunasDesejadas;
  const data = table.rows({ search: "applied" }).data().toArray();
  doc.autoTable({ head: [headers], body: data, styles: { fontSize: 8, cellPadding: 2 }, columnStyles: { 4: { cellWidth: 60, overflow: "linebreak" } } });
  doc.save("recebimento.pdf");
}
function exportExcel(table) {
  const headers = colunasDesejadas;
  const data = table.rows({ search: "applied" }).data().toArray();
  const ws_data = [headers];
  data.forEach(row => ws_data.push([...row]));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Recebimento");
  XLSX.writeFile(wb, "recebimento.xlsx");
}
</script>
